name: Terraform Master Checks

on:
  push:
    branches:
      - main
      - master
    paths:
      - '**.tf'
      - '**.tfvars'
      - '**.sh'
      - 'modules/**'
      - 'terraform/**'
      - 'scripts/**'
      - '.github/workflows/terraform-master-checks.yml'
      - 'Makefile'
      - 'Makefile.common'

env:
  TF_VERSION: "1.5.0"

jobs:
  terraform-fmt:
    name: Terraform Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Check Terraform formatting
        run: |
          echo "Checking Terraform formatting..."
          make tf-fmt-check

  terraform-lint:
    name: Terraform Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v6.2.1

      - name: Initialize TFLint
        run: |
          # Initialize TFLint with AWS plugin
          tflint --init

      - name: Run TFLint on root Terraform
        working-directory: terraform
        continue-on-error: true
        run: |
          echo "Linting root Terraform configuration..."
          tflint --format compact || echo "⚠ TFLint found issues (non-blocking)"

      - name: Run TFLint on modules
        continue-on-error: true
        run: |
          echo "Linting Terraform modules..."
          for module in modules/infrastructure/*/; do
            if [ -d "$module" ]; then
              echo "Linting $module..."
              (cd "$module" && tflint --format compact) || echo "⚠ TFLint found issues in $module (non-blocking)"
            fi
          done

  terraform-validate-modules:
    name: Validate Terraform Modules
    runs-on: ubuntu-latest
    strategy:
      matrix:
        module:
          - bastion
          - cluster
          - iam
          - network-existing
          - network-private
          - network-public
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Validate module ${{ matrix.module }}
        run: |
          echo "Validating module: ${{ matrix.module }}"
          cd modules/infrastructure/${{ matrix.module }}
          if terraform init -backend=false -input=false -upgrade >/dev/null 2>&1; then
            if terraform validate -no-color; then
              echo "✓ Module ${{ matrix.module }} validated successfully"
            else
              echo "✗ Validation failed: ${{ matrix.module }}"
              terraform validate -no-color
              exit 1
            fi
          else
            echo "⚠ Init failed (may need network access or provider plugins): ${{ matrix.module }}"
            echo "  This is expected for modules that require external providers or AWS credentials"
            echo "  Run 'terraform init' manually to see details"
            # Don't fail the job - init failures are expected in CI without credentials
          fi

  terraform-validate-root:
    name: Validate Root Terraform
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Validate root Terraform configuration
        run: |
          echo "Validating root Terraform configuration..."
          cd terraform
          if terraform init -backend=false -input=false -upgrade >/dev/null 2>&1; then
            if terraform validate -no-color; then
              echo "✓ Root configuration validated successfully"
            else
              echo "✗ Root configuration validation failed"
              terraform validate -no-color
              exit 1
            fi
          else
            echo "⚠ Init failed (may need network access or provider plugins)"
            echo "  This is expected without AWS credentials"
            echo "  Run 'terraform init' manually to see details"
            # Don't fail the job - init failures are expected in CI without credentials
          fi

  shellcheck:
    name: Shell Script Lint (ShellCheck)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install ShellCheck
        run: |
          # Install specific version to match local development
          # Local version: 0.11.0
          SHELLCHECK_VERSION="0.11.0"
          wget -qO- "https://github.com/koalaman/shellcheck/releases/download/v${SHELLCHECK_VERSION}/shellcheck-v${SHELLCHECK_VERSION}.linux.x86_64.tar.xz" | tar -xJ
          sudo mv shellcheck-v${SHELLCHECK_VERSION}/shellcheck /usr/local/bin/
          shellcheck --version

      - name: Run ShellCheck on all shell scripts
        run: |
          echo "Linting shell scripts with ShellCheck..."
          make sh-lint

  shfmt:
    name: Shell Script Format Check (shfmt)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install shfmt
        run: |
          wget -q https://github.com/mvdan/sh/releases/download/v3.7.0/shfmt_v3.7.0_linux_amd64 -O shfmt
          chmod +x shfmt
          sudo mv shfmt /usr/local/bin/
          shfmt --version

      - name: Check shell script formatting
        run: |
          echo "Checking shell script formatting..."
          make sh-fmt-check

  # Optional: Terraform Plan (requires AWS credentials)
  # Uncomment and configure AWS credentials if you want to run terraform plan
  # terraform-plan:
  #   name: Terraform Plan (Optional)
  #   runs-on: ubuntu-latest
  #   if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Setup Terraform
  #       uses: hashicorp/setup-terraform@v3
  #       with:
  #         terraform_version: ${{ env.TF_VERSION }}
  #
  #     - name: Configure AWS credentials
  #       uses: aws-actions/configure-aws-credentials@v4
  #       with:
  #         aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
  #         aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  #         aws-region: us-east-1
  #
  #     - name: Setup backend configuration
  #       run: |
  #         export TF_BACKEND_CONFIG_BUCKET="${{ secrets.TF_STATE_BUCKET }}"
  #         export TF_BACKEND_CONFIG_REGION="us-east-1"
  #         export TF_BACKEND_CONFIG_DYNAMODB_TABLE="${{ secrets.TF_STATE_LOCK_TABLE }}"
  #
  #     - name: Terraform Plan (example cluster)
  #       working-directory: terraform
  #       env:
  #         TF_VAR_token: ${{ secrets.RHCS_TOKEN }}
  #       run: |
  #         # Note: This requires a valid cluster configuration
  #         # You may want to create a test cluster configuration for CI/CD
  #         echo "⚠ Terraform plan requires valid cluster configuration and credentials"
  #         echo "⚠ Skipping plan in CI/CD - run manually with proper credentials"

  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs:
      - terraform-fmt
      - terraform-lint
      - terraform-validate-modules
      - terraform-validate-root
      - shellcheck
      - shfmt
    if: always()
    steps:
      - name: Check job results
        run: |
          FAILED=0
          if [ "${{ needs.terraform-fmt.result }}" != "success" ]; then
            echo "❌ Terraform formatting check failed"
            FAILED=1
          fi
          if [ "${{ needs.terraform-validate-modules.result }}" != "success" ]; then
            echo "❌ Terraform module validation failed"
            FAILED=1
          fi
          if [ "${{ needs.terraform-validate-root.result }}" != "success" ]; then
            echo "❌ Terraform root validation failed"
            FAILED=1
          fi
          if [ "${{ needs.shellcheck.result }}" != "success" ]; then
            echo "❌ ShellCheck linting failed"
            FAILED=1
          fi
          if [ "${{ needs.shfmt.result }}" != "success" ]; then
            echo "❌ Shell script formatting check failed"
            FAILED=1
          fi
          if [ $FAILED -eq 1 ]; then
            echo "❌ Some checks failed. Please review the errors above."
            exit 1
          else
            echo "✅ All checks passed!"
          fi
